---
title: "HW5: Real GDP growth and return to S&P 500"
output:
  html_document:
    fig_width: 10
    number_sections: yes
  pdf_document:
    number_sections: yes
---


```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(magrittr)
library(tidyquant)
library(timetk)
library(lubridate)
library(tis)
library(zoo)
library(broom)
library(vars)
library(ggplot2)
library(ggfortify)
library(dygraphs)

theme_set(theme_bw())

myplot <- function(x, ...){
    # get dates for NBER recessions
    rec.dates <- nberDates()
    rec.start <- as.Date(as.character(rec.dates[,"Start"]), "%Y%m%d")
    rec.end   <- as.Date(as.character(rec.dates[,"End"]), "%Y%m%d")
    rec.dates <- data.frame(Start=rec.start, End=rec.end)

    # define function for NBER recession shading
    nber_shades <- function(g, periods){
        for(i in seq_along(periods[,1])){
            g <- dyShading(g, from=periods[i,1], to=periods[i,2], color="#F0F0F8")
        }
        g
    }
    
    # create plot with NBER recession shading
    dygraph(x,...) %>%
        dyOptions(colors=c("#000000","#FF0000","#FF0000","#FF0000"), drawPoints=TRUE, pointSize=1 ) %>%
        nber_shades(rec.dates)  %>%
        dyLimit(0, strokePattern="dotted") %>% 
        dyLegend(width=750)
}
```

# Introduction

This short note analyzes the relationship between the growth rate of real GDP and the return to S&P 500 index using Vector Autoregression (VAR) and Granger causality methodology.

# Data

First, we import the quarterly time series for real GDP, GDP deflator, and S&P 500 index from Quandl website
```{r, message=FALSE, cache=TRUE}
library(Quandl)
# import data on real GDP and GDP deflator
rGDP <- Quandl("FRED/GDPC1", type ="zoo")
pGDP <- Quandl("FRED/GDPDEF", type ="zoo")
# import data on S&P 500 index
SP500.data <- Quandl("YAHOO/INDEX_GSPC", collapse="quarterly", type ="zoo")
SP500 <- SP500.data$Close
```

```{r, echo=FALSE, message=FALSE}
library(zoo)
```

We next construct time series for log change in GDP $y_{1,t} = \Delta\log rGDP_t$ (which approximates the growth rate of the real GDP) and the real log return for S&P 500 index $y_{2,t} = \Delta \log SP500_t - \Delta \log p^{GDP}_t$ (which approximates the inflation adjusted return of S&P 500). 

```{r}
y1 <- diff(log(rGDP))
y2 <- diff(log(SP500)) - diff(log(pGDP))
```

The sample used for the analysis is set to 1951Q1-2014Q4.
```{r}
y.ord1 <- na.trim( cbind(y1,y2) )
# y.ord1 <- sweep(y.ord1, 2, apply(y.ord1, 2, mean))
y.ord1 <- window(y.ord1, start="1951 Q1", end="2014 Q4")
```

```{r, fig.width=9, fig.height=3}
myplot(y1, group="dlrGDPvsdlrSP500", main="log change in real GDP")
myplot(y2, group="dlrGDPvsdlrSP500", main="log change in S&P 500 index, inflation adjusted")
```

# Bivariate Reduced Form VAR

We use information criteria to determine the number of lags included in the VAR. IN this particular case Akaike information criterion, Schwarz-Bayesian criterion and Hannan-Quinn information criterion all suggest to include two lags.

```{r, message=FALSE, warning=FALSE}
library(vars)
VARselect(y.ord1, lag.max=12)$selection
```

Below are the results obtained by estimating the two equations in the VAR using equation by equation OLS.
```{r}
var.ord1 <- VAR(y.ord1, ic="SC", lag.max=12)
summary(var.ord1)
```

As shown in the output above, the correlation of residuals from the two equations is relatively low, $\rho_{e_1,e_2} =$ `r 
format(cor(var.ord1$varresult$y1$residuals, var.ord1$varresult$y2$residuals), digits=4)`. Consequently, the ordering of variables in the VAR will not matter much for the IRFs obtained by Choleski decomposition. 

# Granger Causality Tests

To assess the predictive ability of the two variables in the VAR we next perform Granger causality test.
```{r}
causality(var.ord1, cause="y1")$Granger
causality(var.ord1, cause="y2")$Granger
```
The results of the two Granger causality test show that:  
- we can not reject the hypothesis that changes in real GDP do not Granger cause changes in S&P 500 index  
- we reject the hypothesis that changes in S&P 500 index do not Granger cause changes in the real GDP  

Downturns in the financial market thus foreshadow downturns in real economy: loses in S&P 500 index predict decline in real GDP growth rate in the future. Recall however that word causality in Granger causality is somewhat of a misnomer - loses in financial markets are not necessarily *causing* the decline in real GDP, these loses might be the result of traders rationally predicting future GDP decline that is caused by a third factor (potentially completely unrelated to financial markets - for example political instability, oil price shocks, ...) and factoring in this decline into the stock prices because of lower future profits and dividends. Granger causality is merely evaluating whether one variable is useful in predicting the other one.

# Restricted VAR Model

Based on the result of Granger causality test we estimate restricted VAR - remove lags of log change in GDP from the equation for inflation adjusted log change in S&P 500 index. In this specification inflation adjusted log change in S&P 500 index is explained  only by an intercept an it's own lags, though these lag are only marginally significant.

```{r}
mat.ord1.r <- matrix(1, nrow=2, ncol=(1+2*var.ord1$p))
mat.ord1.r[2, 2*seq(1,var.ord1$p) - 1] <- 0
var.ord1.r <- restrict(var.ord1, method="manual", resmat=mat.ord1.r)
summary(var.ord1.r)
```

Alternatively, we can estimate restricted VAR by keeping only variables with t-value larger than 2.0. This removes all variables except of the constant from the equation for inflation adjusted log change in S&P 500 index.

```{r}
var.ord1.r.ser <- restrict(var.ord1, method="ser", thresh=2.0)
summary(var.ord1.r.ser)
```

The following table summarizes the result for the unrestricted and restricted VARs.

```{r, results="asis"}
lm.y1 <- var.ord1$varresult$y1
lm.y2 <- var.ord1$varresult$y2
lm.y1.r <- var.ord1.r$varresult$y1
lm.y2.r <- var.ord1.r$varresult$y2
lm.y1.r.ser <- var.ord1.r.ser$varresult$y1
lm.y2.r.ser <- var.ord1.r.ser$varresult$y2

library(stargazer)
stargazer(lm.y1, lm.y2, lm.y1.r, lm.y2.r, lm.y1.r.ser, lm.y2.r.ser,
          type="html", column.labels=rep(c("dlog(GDP)","dlog(SP500) - dlog(pGDP)"),3), 
          dep.var.labels.include=FALSE)
```


# Impulse-Response Function 

```{r}
source("../../Codes/plotIRF.r")
```

The graph below shows the impulse-response functions for the VAR restricted based on results from Granger causality tests.

```{r}
# construct IRF for ordering (y1,y2)
myIRF <- irf(var.ord1.r, n.ahead=16, ci=.9)
# plot IRF for ordering (y1,y2)
par(mfrow=c(2,2), cex=0.8, mar=c(4,4,2,1))
plotIRF(myIRF, lwd=2.5, ask=FALSE, vlabels=c("dlog(rGDP)","dlog(SP500/pGDP)"), 
        slabels=c("shock to dlog(GDP)","shock to dlog(SP500/pGDP)"))
```

To examine the effect of alternative ordering, we re-estimate the VAR with variables $y_{1,t}$ and $y_{2,t}$ in reversed order, and again restrict it based on the Granger causality test.

```{r}
y.ord2 <- y.ord1[,c(2,1)]
var.ord2 <- VAR(y.ord2, ic="SC", lag.max=12)

mat.ord2.r <- matrix(1, nrow=2, ncol=(1+2*var.ord2$p))
mat.ord2.r[1, 2*seq(1,var.ord1$p)] <- 0

var.ord2.r <- restrict(var.ord2, method="manual", resmat=mat.ord2.r)
```

Reversing the order so that the $y_{1,t} = \Delta \log rGDP_t$ comes second after $y_{2,t} = \Delta \log (SP500_t/p^{GDP}_t)$ together with restriction on the lags included due to Granger causality results implies that $y_{2,t}$ is weakly exogenous - it is not affected by current or past values of $y_{1,t}$ or $\varepsilon_{1,t}$. The IRF of $y_{2,t}$ after a shock to $y_{1,t}$ is therefore flat zero line. Other than that, the IRFs are very similar in shape and magnitude to those under original ordering. As already mentioned above, the reason why ordering matters little in this case, is a low correlation among residuals of reduced form VAR.

```{r}
# construct IRF for ordering (y1,y2)
myIRF2 <- irf(var.ord2.r, n.ahead=16, ci=.9)
# rearrange the constructed IRFs, so that the plot is easier to compare with the one for previous ordering
myIRF2$impulse[1:2] <-myIRF2$impulse[2:1]
myIRF2$response[1:2] <- myIRF2$response[2:1]
# plot IRF for ordering (y2,y1)
par(mfrow=c(2,2), cex=0.8, mar=c(4,4,2,1))
plotIRF(myIRF2, lwd=2.5, ask=FALSE, vlabels=c("dlog(rGDP)","dlog(SP500/pGDP)"), 
        slabels=c("shock to dlog(GDP)","shock to dlog(SP500/pGDP)"))
```


# Forecast Error Variance Decomposition

The two charts below show the forecast error variance decomposition under the two different orderings of variables. Just like with impulse-response functions, the ordering does not matter much for results. Most of the volatility of $y_{1,t}= \Delta \log GDP_t$ is caused by innovations $\varepsilon_{1,t}$, but for longer horizons about 15% is caused by innovations $\varepsilon_{2,t}$. The volatility of $y_{2,t}= \Delta \log (SP500_t/p_t^{GDP_t})$ is almost entirely cause by innovations $\varepsilon_{2,t}$, even for ordering $(y_{1,t},y_{2,t})$ less than 2% is caused by innovations $\varepsilon_{1,t}$.
```{r}
# construct FEVD for alternative orderings
var.ord1.r.fevd <- fevd(var.ord1.r, n.ahead=16)
var.ord2.r.fevd <- fevd(var.ord2.r, n.ahead=16)
# rearrange elements of FEVD output for easier comparison in charts
tmp <- list()
tmp[["y1"]] <- var.ord2.r.fevd[[2]][,c(2,1)]
tmp[["y2"]] <- var.ord2.r.fevd[[1]][,c(2,1)]
var.ord2.r.fevd <- tmp
class(var.ord2.r.fevd) <- "varfevd"
# plot FEVD for the two orderings
par(mfrow=c(2,2), cex=0.8, mar=c(4,4,2,1))
plot(var.ord1.r.fevd)
plot(var.ord2.r.fevd)
```


&nbsp;
